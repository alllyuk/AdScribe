Зомбовидное название задачи:

Multilingual (Russian) multimodal (text+img) multiimage (many images) captioning with masking 

Архитектура сервиса:
                                                потом это убрать: (делаем просто на время тестирований)
                                                У пользователя была возможность выбрать подходящую модель (НАЗВАНИЕ ПАПКИ в каталоге с чекпоинтами)
  +----------------+                                           +----------------------------------------------+                                            0. Валидность формата входных данных
  |   User Input   | ----------------------------------------> | Пользователь нажал на кнопку "Сгенерировать" |----------------------->   Блок модерации   1. Модерация фото,     notAI-tech/NudeNet                             
  +----------------+                                           +----------------------------------------------+                                |           2. модерация текста    unitary/toxic-bert (multilingual) / cointegrated/rubert-tiny-toxicity,
                                                                                      |                                                        |           3. модерация соответствия фото-текст    ruCLIP                          
  {'Вид одежды': 'Для девочек',                                                       V                                                        V                                                                                                       
   'Предмет одежды': 'Обувь',                                             +-----------------------+                                     Блок  модерации  -------------------------------------------> Да. Успешно.
   'Состояние': 'Новый',                                                  | User Input не пустой? |                                     пройден успешно?                                                 |                                             
   'Вид объявления': 'Товар приобретён на продажу',                       +-----------------------+                                            |                                                         V
   'Размер': '30 (19 см)',                                                            |                                                        V                                              Что пользователь загрузил?                                
   'Цена': '5000', ...                                                                V                                                       Нет.                                                       |                                                                                                                                                                      ** ДЛЯ НЕК ПОДХОДОВ в единый блок     
  }                                                                       +-----------------------+                                            |                                                         ------------------------> Много картинкок и текст -----------------+
                                                                          |        Пустой.        |                                            V                                                         |                                                                  |---> Максирование текстовых данных <PRICE>, <SIZE>, ...  ---> Классификатор множественности -----> MultiImage Model----------------> Замена маскированных токенов на __, есть новые? стереть. каких-то нет? ну, увы ----> Output ------> {Сгенерированный текст, время модерации, время генерации, средняя/максимальная схожесть текста и картинок/картинок между собой/исходного текста и полученного (ruCLIP, BERTScore) }
    +                                                                     +-----------------------+                                    Ошибка. Напомнить о                                               ------------------------> Много картинок без текста----------------+
                                                                                                                                       назначении сервиса.                                               |
                                                                                      |                                                                                                                  ------------------------> Текст без картинок---------------------------> Максирование текстовых данных <PRICE>, <SIZE>, ...    -----> SingleImage Model--------------->   Замена маскированных токенов на __, есть новые? стереть. каких-то нет? ну, увы х----> Output ------> {Сгенерированный текст, время модерации, время генерации, средняя/максимальная схожесть текста и картинок/картинок между собой/исходного текста и полученного (ruCLIP, BERTScore) }
  Картинки                                                                            V
  - до 10 штук                                                   Предупреждение о необходимости заполнить поля
  - формат: jpg (jpeg), png, gif                                 Напоминание о наличии предзагруженных тест-кейсов
  - размер каждой: до 25 мб                                      (ТЕСТ-КЕЙСЫ - Название папки в каталоге с тестами)
                                                                Кейс 1.1 Одно фото, один предмет
                                                                Кейс 1.2 Несколько фото, один предмет
                                                                Кейс 2.1 Много маскирования
                                                                Кейс 3.1 Несколько разных предметов на фото
                                                                Кейс 3.2 Разные предметы одного типа (набор стульев)
                                                                Кейс 3.3 Много одинаковых предметов
                                                                Кейс 4 Картинка не относится к тексту   - ошибка
                                                                Кейс 5 Текст не относится к картинке    - ошибка
                                                                Кейс 6 Генерация только по тексту       - модель сгенерирует без картинки 
                                                                Кейс 7 Генерация только по картинке     - модель сгенерирует без текста
                                                                Кейс 8 Генерация только по картинкам    - модель, сгенерирует используя все картинки, без текста
  






А    2. Рефакторинг кода сервиса и добавление моделей модерации
А      Из всех картинок выбирается одна (CLIPScore - ruCLIP) и генерируется текст
А     BLIP2

М   1. Доделать EDA (информация о датасете, о метриках, о решениях проблем, собрать маски).




*  Итерация 1. Налаживание сервиса ВСТРОИТЬ ПАЙПЛАЙН БЕЗ ДООБУЧЕНИЯ
*  Исходные модели - tuman/vit-rugpt2-image-captioning (используется в авито сейчас),
*  Попробовать костыль 




М Итерация 2. Создаем классификатор diversity 

1) Настроить получение метки разнообразия для каждого объявления (float diversity_score от 0 до 1)
     Если в объявлении много разных предметов, то оно должно быть помечено как diversity=1.
     1.1) Для этого необходимо разметить полуручным способом (с регулярными выражениями по тексту)
          несколько сотен примеров (500+) - (например, 250 с diversity=1 и 250 с diversity=0).
          Реализовать и протестировать классификатор с accuracy > 0.9 
     1.2) Применить классификатор к обоим датасетам (новому и старому) и получить колонку diversity_score

     альтернативно:

     1.1) Взять ruCLIP и подать ему фотку и два списка описаний:
          - variative = ['разнообразие товаров', 'много предметов', 'много вещей']
          - single = ['один товар', 'продукт', 'одна штука']
          - посчитал 6 CLIP-similarities, взял у них среднее, получил признак 

     можно реализовать оба варианта и сравнить их

     ожидается -> классификатор множественности

2) Выбранным способом будут получены метки diversity_score для всех объявлений
   в модель будут подаваться как скрытые токены  <VARIATIVE> и <SINGLE>
  
Итерация 3. Добавляем маскирование и скрытые токены - <SINGLE> и <VARIATIVE>

должна быть функция, которая заменяет все цифры на placeholders
     из конкретного списка (например, <PRICE>, <SIZE>), но при этом,
     добавить токен <UNK_VAL> для признаков, которые мы могли не увидеть 
     раннее.
     Определять на что заменять по словам перед цифрой (например,
     <PRICE> - цена, <SIZE> - размер и т.д.)


===============================================================================

Итерация 4. Создаем датасет с многокартинковостью

Мультикартиночность делаем отдельно - TempoFunk/webvid-10M

Как сделать multi-image-caption из видео-датасета - video+caption
Скачать датасет (или часть) — например, TVSum.
Разбить каждое видео на N равномерных кадров (например, 5–10 скриншотов).
Пример: каждые X секунд или равномерно по длительности.
Использовать summary или описание видео в качестве “caption” для набора скриншотов.

Готово: [screenshot1, screenshot2, ..., screenshotN] → summary.


На английском? Значит переводим. 

у датасета не забыть про diversity_score

!!! ВАЖНО !!!
Выцепить отсюда 20% на тест. 

- ruDolph (от сбера, как та что выше, но новее и живее) ПОСТРАТЬСЯ НЕ ЧЕРЕЗ АПИ

--------------------------------------------------------------------------------------------------------------------------------------

Итерация 5. Встраиваем многокартинковость, не забыть про маскирование и diversity_score

0!!!!) OPEN FLAMINGO ФРЕЙМВОРК, БЕРЕШЬ DECODER ONLY LM + VISION ENCODER (VIT) 
       https://github.com/mlfoundations/open_flamingo/tree/main

1-2 модели) vit-rugpt2 и ruDolph

Софт промптинг

  - каждая картинка -> ViT -> Линейный слой (768 -> 1024) ->
    -> softprompt (вектор длины 1024) -> добавляем в input_hidden_states
    перед текстом, между картинками можно вставлять спецтокены <IMG_i>

  - Лора на датасет с многокартинковостью, А ПОТОМ ЛОРА НА ОСНОВНОЙ ДАТАСЕТ

    https://github.com/ai-forever/ru-dolph/tree/master/jupyters

3 модель) Blip2 с замененной ллм

  способы мультикартиночности:
  способ 1. независимая обработка
  каждая картинка → ViT → Q-Former → токены → объединяются и подаются в LLM.
  сохраняет порядок. нативно для BLIP-2. LoRA на Q-Former.
  способ 2. ViT на пачку
  все картинки сразу скармливаются ViT как батч → объединённый визуальный вход → Q-Former.
  модель может путаться. нужен контроль позиций. LoRA.

  варианты блип-базы:

- mBLIP2 + RuT5/RuBART 
 - how to change llm - смотри в репе https://github.com/gregor-ge/mBLIP/issues/15

А ПОТОМ ЛОРА НА ОСНОВНОЙ ДАТАСЕТ


4 модель) ruClipCap (based on ruCLIP + ruGPT)

- ruCLIPCAP+ маски + многокартинковость

RuCOCO -    https://github.com/AlexWortega/ru_COCO?ysclid=mavhtsid8m796392388
ClipCap -   https://github.com/rmokady/CLIP_prefix_caption
RuClipCap - https://github.com/rbeketov/clipcap-nas/tree/619f8d3c30d83d790306d067647333e5dbcb604a
          - ViT-B-16-plus-240, ruclip-vit-base-patch32-384, rugpt3medium_based_on_gpt2

- LoRA на датасет с многокартинковостью

- LoRA на датасет с основным датасетом



Итерация 6. Выбор наилучшей модели и оставление только ее в сервисе



Важные приколы:

---> Человечность в лоссе на последней LoRa
      
      def similarity() = cosine_similarity / BERTScore

      pred = tokenizer.decode()
      human_descr = inputs["labels"]
      GPT4_descr = inputs["gpt_texts"]

      reward = cider(pred, human_descr) - β * similarity(pred, GPT4_descr)
    ( награда за человечность = близость к человеку - β * близость к GPT4 )
    
      LOSS -= α * reward (α - вес человечности)


CIDEr - насколько мы попали в человеческое описание (0 нет - 5 безумно хорошо)
      BERTScore - насколько мы попали в GPT4 (0 нет - 1 мы как GPT4, под капотом у метрики - BERT)
      cosine_similarity - насколько мы попали в CLIP (0 нет - 1 безумно хорошо)


---> На какие метрики смотрим при обучении и на тесте?

CLIPScore по mean всех изображений
- сравниваем все изображения и текст (0 - 1)
  clip_mean_scores = [clipscore_mean(p, images[i]) for i, p in enumerate(pred_texts)]

BERTScore (vs Human, vs GPT)
- сравниваем предсказание с эталонами (0 - 1)
  bert_human = bertscore(pred_texts, human_refs)
	
CIDEr
- насколько текст похож на человеческое описание (0 - 5)  
  cider(pred_texts, human_refs) - β * bert_gpt  Насколько описание похоже на GPT4
  cider(pred_texts, gpt4_refs) - β * bert_gpt  	Анти-человечность (пишем как GPT — плохо)
      
Человечность
  cider(pred_texts, human_refs) - β * bert_gpt

  [0, 5] - [0, 1] * [0, 1]

  => человечность принимает значения от 0 до 5

Классика
  BLEU-1,2,3,4 - Показывают совпадения по n-граммам. Оценка лексического совпадения.
  ROUGE-L - Учитывает наибольшую общую подпоследовательность между сгенерированным и референсным текстом.
  METEOR - Более "гуманная" метрика, учитывающая синонимы и морфологию.
        

---> Какие метрики сможем потом отдать пользователю, не зная эталоны?

    "clipscore_mean": average(CLIP(imgs), caption), Средняя схожесть текста со всеми изображениями (по CLIP)
    "clipscore_max": max(CLIP(imgs), caption), Максимальная схожесть текста с одним из изображений (по CLIP)



















--------------------------------------ПЛАНИРОВАЛОСЬ---------------------------------------------

Создаем датасет, который будет учить модели многокартиночности 
  (часть картинок - однокартинковые, часть - реальные мультикартинки, третья часть -
   копии однокартинковых изображений, но с разными аугментациями. при этом должны 
   быть все картинки из основного датасета (одежда))

   основной датасет: 
   Всего объявлений: 37441, 
   у 32839 из них есть больше 1 картинки, 
   чаще всего 3 картинки - 9829 раз.
   всего картинок  117329

   +

   датасет MLCUP (однокартинковый)
   Объявлений больше 2.3 млн


Датасет в сумме будет таким:

Источник 1: Основной датасет
Категория	                                        Строк (объявлений)	   Картинок	      Комментарий
MULTI_REAL (multi ≥2 image)	                      32 839	               117 329	      Использованы полностью
SINGLE_MAIN (с 1 изображением)	                  4 602	                 4 602	        Использованы полностью
AUG_MAIN (аугментация SINGLE_MAIN, ~2.5×)	        5 000	                 ~12 500	      Семпл из SINGLE_MAIN, синтетический
Всего	                                            42 441	               ~134 431	

Источник 2: MLCUP (однокартинковый)
Категория	                                        Строк (объявлений)	    Картинок	      Комментарий
SINGLE_MLCUP (без изменений)	                    15 000	                15 000	        Семпл из 2.3 млн
AUG_MLCUP (аугментации, ~2.5×)	                  10 000	                ~25 000	        Синтетический multi из одиночек
Всего	                                            25 000	                ~40 000	
